{% extends 'base.html.twig' %} 



 {%  block content %}


 <div class="container-xxl flex-grow-1 container-p-y">

<div class="mb-3 d-flex flex-column flex-md-row align-items-start gap-2">
  <div class="d-flex flex-column">
    <label for="date-filter" class="form-label">Filtrer par date :</label>
    <input type="date" id="date-filter" class="form-control w-100 w-md-auto">
  </div>

  <!-- Boutons -->
  <div class="d-flex gap-2 mt-2 mt-md-4">
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addFolderModal">
      + Ajouter un dossier
    </button>

    <button class="btn btn-info"
      onclick="document.getElementById('date-filter').value=''; document.getElementById('date-filter').dispatchEvent(new Event('change'));">
      RÃ©initialiser
    </button>
  </div>
</div>




<!-- La fenÃªtre modale Bootstrap -->
<div class="modal fade" id="addFolderModal" tabindex="-1" aria-labelledby="addFolderModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{{ path('app_dossier_create') }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addFolderModalLabel">CrÃ©er un nouveau dossier</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="nom_dossier" class="form-label">Nom du dossier</label>
            <input type="text" class="form-control" id="nom_dossier" name="nom" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary">CrÃ©er</button>
        </div>
      </div>
    </form>
  </div>
</div>


<div class="row row-cols-1 row-cols-md-4 g-3 mb-5" id="fichier-grid">
  {% for fichier in fichiersSansDossier %}
    {% set ext = fichier.chemin|split('.')|last|lower %}
    {% set isImage = ext in ['jpg', 'jpeg', 'png', 'gif', 'webp'] %}
    {% set dateUpload = fichier.uploadedAt ? fichier.uploadedAt|date('Y-m-d') : '' %}

    <div class="col fichier-card" data-date="{{ dateUpload }}">
      <div class="card h-100 shadow-sm p-2">
        {% if isImage %}
          <img class="card-img-top img-fluid" src="{{ asset('uploads/' ~ fichier.chemin) }}" alt="{{ fichier.nom }}" style="max-height: 150px; object-fit: cover;">
        {% else %}
          <img class="card-img-top img-fluid" src="{{ asset('uploads/default-file-icon.png') }}" alt="Fichier" style="max-height: 150px; object-fit: contain;">
        {% endif %}
        <div class="card-body p-2">
          <h6 class="card-title small text-truncate" title="{{ fichier.nom }}">{{ fichier.nom }}</h6>
          <p class="card-text small text-muted mb-1">ðŸ“… {{ dateUpload ? dateUpload|date('d/m/Y') : 'Inconnu' }}</p>
        </div>
        <div class="card-footer bg-white border-top-0 d-flex justify-content-between p-2">
          <a class="btn btn-sm btn-outline-primary" href="{{ asset('uploads/' ~ fichier.chemin) }}" target="_blank">Voir</a>
          <form method="post" action="{{ path('app_fichier_supprimer', { id: fichier.id }) }}" onsubmit="return confirm('Supprimer ce fichier ?');">
            <button type="submit" class="btn btn-sm btn-outline-danger">ðŸ—‘</button>
          </form>
        </div>
      </div>
    </div>
  {% else %}
    {# <div class="col">
      <div class="alert alert-warning w-100">Aucun fichier trouvÃ©.</div>
    </div> #}
  {% endfor %}



  {% for dossier in dossiers %}
      {% set dateUploadd = dossier.createAt ? dossier.createAt|date('Y-m-d') : '' %}

  <div class="col fichier-card" data-date="{{ dateUploadd }}" >
    <a href="{{ path('app_dossier_afficher', { id: dossier.id }) }}" class="text-decoration-none text-dark">
      <div class="card h-100 shadow-sm p-2">

      {% if dossier.users|length > 1 %}
    {% set autres_users = dossier.users|filter(u => u.id != app.user.id) %}
    {% set noms_users = autres_users|map(u => u.email)|join(', ') %}

    <span class="badge bg-primary position-absolute top-0 end-0 m-2" title="PartagÃ© avec : {{ noms_users }}">
        P
    </span>
{% endif %}

        <img class="card-img-top img-fluid" src="{{ asset('assets/img/icons/foldergreen_93329.png') }}" alt="Dossier" style="max-height: 200px; object-fit: contain;">
        <div class="card-body p-2">
          <h6 class="card-title small text-truncate" title="{{ dossier.nom }}">{{ dossier.nom }}</h6>
                    <p class="card-text small text-muted mb-1">ðŸ“… {{ dateUploadd ? dateUploadd|date('d/m/Y') : 'Inconnu' }}</p>

        </div>
        </a>
        <div class="card-footer bg-white border-top-0 d-flex justify-content-between p-2">
          <span class="btn btn-sm btn-outline-primary disabled">Ouvrir</span>
            <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#partagerModal{{ dossier.id }}">Partager</button>

        </div>
      </div>
    
    
  </div>
  <!-- Modal de partage -->
<div class="modal fade" id="partagerModal{{ dossier.id }}" tabindex="-1" aria-labelledby="partagerModalLabel{{ dossier.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ path('app_dossier_partager') }}">
        <div class="modal-header">
          <h5 class="modal-title" id="partagerModalLabel{{ dossier.id }}">Partager le dossier : {{ dossier.nom }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="dossier_id" value="{{ dossier.id }}">
          <div class="mb-3">
            <label for="userSelect{{ dossier.id }}" class="form-label">SÃ©lectionner un utilisateur :</label>
            <select name="user_id" id="userSelect{{ dossier.id }}" class="form-select" required>
              {% for utilisateur in all_users %}
                {% if utilisateur != app.user %}
                  <option value="{{ utilisateur.id }}">{{ utilisateur.email }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Partager</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}


</div>
</div>



<script>
  document.getElementById('date-filter').addEventListener('change', function () {
    const selectedDate = this.value;
    const cards = document.querySelectorAll('.fichier-card');

    cards.forEach(card => {
      const cardDate = card.getAttribute('data-date');
      if (!selectedDate || cardDate === selectedDate) {
        card.style.display = 'block';
      } else {
        card.style.display = 'none';
      }
    });
  });
</script>


<!-- Bootstrap JS Bundle (inclut Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}















{# 

<table border="1" cellpadding="10" id="fichiers-table">
    <thead>
        <tr>
            <th>Nom</th>
            <th>Fichier</th>
            <th style="cursor:pointer;" onclick="sortTable()">Date dâ€™upload &#x25B2;&#x25BC;</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% for fichier in fichiers %}
            <tr>
                <td>{{ fichier.nom }}</td>
                <td>
                    {% set ext = fichier.chemin|split('.')|last|lower %}
                    {% if ext in ['jpg', 'jpeg', 'png', 'gif', 'webp'] %}
                        <img src="{{ asset('uploads/' ~ fichier.chemin) }}" alt="{{ fichier.nom }}" width="100">
                    {% else %}
                        <a href="{{ asset('uploads/' ~ fichier.chemin) }}" target="_blank">
                            Voir / TÃ©lÃ©charger
                        </a>
                    {% endif %}
                </td>
                <td data-date="{{ fichier.uploadedAt ? fichier.uploadedAt|date('Y-m-d H:i:s') : '' }}">
                    {{ fichier.uploadedAt ? fichier.uploadedAt|date('d/m/Y H:i') : 'Non dÃ©fini' }}
                </td>
                <td>
                    <form method="post" action="{{ path('app_fichier_supprimer', { id: fichier.id }) }}" onsubmit="return confirm('Supprimer ce fichier ?');">
                        <button type="submit">ðŸ—‘ Supprimer</button>
                    </form>
                </td>
            </tr>
        {% else %}
            <tr>
                <td colspan="4">Aucun fichier trouvÃ©.</td>
            </tr>
        {% endfor %}
    </tbody>
</table>
<script>
let asc = true;

function sortTable() {
    const table = document.getElementById("fichiers-table");
    const tbody = table.tBodies[0];
    const rows = Array.from(tbody.rows);

    rows.sort((a, b) => {
        const dateA = a.cells[2].getAttribute('data-date');
        const dateB = b.cells[2].getAttribute('data-date');

        if (!dateA) return 1;
        if (!dateB) return -1;

        if (asc) {
            return new Date(dateA) - new Date(dateB);
        } else {
            return new Date(dateB) - new Date(dateA);
        }
    });

    // RÃ©attache les lignes triÃ©es
    rows.forEach(row => tbody.appendChild(row));

    asc = !asc; // Inverse le sens pour le prochain clic
}
</script> #}
